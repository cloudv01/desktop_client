# # # # # name: Build Branded Windows Client

# # # # # on:
# # # # #   push:
# # # # #     branches: [ master, main ]
# # # # #   workflow_dispatch:

# # # # # jobs:
# # # # #   build:
# # # # #     runs-on: windows-2022
# # # # #     env:
# # # # #       CRAFT_TARGET: windows-msvc2022_64-cl
# # # # #       CRAFT_MASTER_LOCATION: ${{ github.workspace }}\CraftMaster
# # # # #       CRAFT_MASTER_CONFIG: ${{ github.workspace }}\craftmaster.ini

# # # # #     steps:
# # # # #       - name: Checkout Code
# # # # #         uses: actions/checkout@v4
# # # # #         with:
# # # # #           fetch-depth: 0

# # # # #       - name: Setup Python
# # # # #         uses: actions/setup-python@v5
# # # # #         with:
# # # # #           python-version: '3.12'

# # # # #       - name: Install Inkscape (Required for Icons)
# # # # #         shell: pwsh
# # # # #         run: |
# # # # #           choco install inkscape --no-progress -y
# # # # #           # Add Inkscape to PATH immediately for the current session
# # # # #           echo "C:\Program Files\Inkscape\bin" >> $env:GITHUB_PATH

# # # # #       - name: Install Build Tools (Craft)
# # # # #         shell: pwsh
# # # # #         run: |
# # # # #           git clone -q --depth=1 https://invent.kde.org/packaging/craftmaster.git ${{ env.CRAFT_MASTER_LOCATION }}
          
# # # # #           function craft() {
# # # # #               python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" --config "${{ env.CRAFT_MASTER_CONFIG }}" --target ${{ env.CRAFT_TARGET }} -c $args
# # # # #               if($LASTEXITCODE -ne 0) {exit $LASTEXITCODE}
# # # # #           }
          
# # # # #           craft --add-blueprint-repository "https://github.com/nextcloud/craft-blueprints-kde.git|stable-4.0|"
# # # # #           craft --add-blueprint-repository "https://github.com/nextcloud/desktop-client-blueprints.git|stable-4.0|"
# # # # #           craft craft
# # # # #           craft --install-deps nextcloud-client

# # # # #       - name: Compile and Package
# # # # #         shell: pwsh
# # # # #         run: |
# # # # #           function craft() {
# # # # #               python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" --config "${{ env.CRAFT_MASTER_CONFIG }}" --target ${{ env.CRAFT_TARGET }} -c $args
# # # # #               if($LASTEXITCODE -ne 0) {exit $LASTEXITCODE}
# # # # #           }
          
# # # # #           # Build using your source code
# # # # #           craft --src-dir ${{ github.workspace }} nextcloud-client
# # # # #           # Create the .exe installer
# # # # #           craft --package nextcloud-client

# # # # #       - name: Upload Branded Installer
# # # # #         uses: actions/upload-artifact@v4
# # # # #         with:
# # # # #           name: Branded-Nextcloud-Installer
# # # # #           path: |
# # # # #             ${{ github.workspace }}\${{ env.CRAFT_TARGET }}\tmp\artifacts\*.exe
# # # # #             ${{ github.workspace }}\${{ env.CRAFT_TARGET }}\tmp\artifacts\*.msi

# # # # name: Build Branded Windows Client

# # # # on:
# # # #   push:
# # # #     branches: [ master, main ]
# # # #   workflow_dispatch:

# # # # jobs:
# # # #   build:
# # # #     runs-on: windows-2022
# # # #     env:
# # # #       CRAFT_TARGET: windows-msvc2022_64-cl
# # # #       CRAFT_MASTER_LOCATION: ${{ github.workspace }}\CraftMaster
# # # #       CRAFT_MASTER_CONFIG: ${{ github.workspace }}\craftmaster.ini
# # # #       # Define where dependencies are stored to cache them
# # # #       CRAFT_ROOT: ${{ github.workspace }}\windows-msvc2022_64-cl

# # # #     steps:
# # # #       - name: Checkout Code
# # # #         uses: actions/checkout@v4
# # # #         with:
# # # #           fetch-depth: 0

# # # #       # --- CACHE LOGIC ---
# # # #       # This looks for a saved version of the dependencies.
# # # #       # If found, it downloads them in ~2 mins instead of building for 40 mins.
# # # #       - name: Cache Craft Dependencies
# # # #         id: cache-craft
# # # #         uses: actions/cache@v4
# # # #         with:
# # # #           path: ${{ env.CRAFT_ROOT }}
# # # #           key: ${{ runner.os }}-craft-v1-${{ hashFiles('**/craftmaster.ini') }}
# # # #           restore-keys: |
# # # #             ${{ runner.os }}-craft-v1-

# # # #       - name: Setup Python
# # # #         uses: actions/setup-python@v5
# # # #         with:
# # # #           python-version: '3.12'

# # # #       - name: Install Inkscape (Required for Icons)
# # # #         shell: pwsh
# # # #         run: |
# # # #           choco install inkscape --no-progress -y
# # # #           echo "C:\Program Files\Inkscape\bin" >> $env:GITHUB_PATH

# # # #       - name: Install Build Tools (Craft)
# # # #         shell: pwsh
# # # #         run: |
# # # #           # Only clone CraftMaster if it doesn't exist
# # # #           if (!(Test-Path "${{ env.CRAFT_MASTER_LOCATION }}")) {
# # # #             git clone -q --depth=1 https://invent.kde.org/packaging/craftmaster.git ${{ env.CRAFT_MASTER_LOCATION }}
# # # #           }
          
# # # #           function craft() {
# # # #               python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" --config "${{ env.CRAFT_MASTER_CONFIG }}" --target ${{ env.CRAFT_TARGET }} -c $args
# # # #               if($LASTEXITCODE -ne 0) {exit $LASTEXITCODE}
# # # #           }
          
# # # #           # These prepare the environment; if cache hit, these skip the hard work
# # # #           craft --add-blueprint-repository "https://github.com/nextcloud/craft-blueprints-kde.git|stable-4.0|"
# # # #           craft --add-blueprint-repository "https://github.com/nextcloud/desktop-client-blueprints.git|stable-4.0|"
# # # #           craft craft
# # # #           craft --install-deps nextcloud-client

# # # #       - name: Compile and Package
# # # #         shell: pwsh
# # # #         run: |
# # # #           function craft() {
# # # #               python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" --config "${{ env.CRAFT_MASTER_CONFIG }}" --target ${{ env.CRAFT_TARGET }} -c $args
# # # #               if($LASTEXITCODE -ne 0) {exit $LASTEXITCODE}
# # # #           }
          
# # # #           # This compiles YOUR specific branded code
# # # #           craft --src-dir ${{ github.workspace }} nextcloud-client
          
# # # #           # This creates the .exe installer
# # # #           craft --package nextcloud-client

# # # #       - name: Upload Branded Installer
# # # #         uses: actions/upload-artifact@v4
# # # #         with:
# # # #           name: Branded-Nextcloud-Installer
# # # #           path: |
# # # #             ${{ env.CRAFT_ROOT }}\tmp\artifacts\*.exe
# # # #             ${{ env.CRAFT_ROOT }}\tmp\artifacts\*.msi

# # # name: Build Branded Windows Client

# # # on:
# # #   push:
# # #     branches: [ master, main ]
# # #   workflow_dispatch:

# # # jobs:
# # #   build:
# # #     runs-on: windows-2022
# # #     env:
# # #       CRAFT_TARGET: windows-msvc2022_64-cl
# # #       CRAFT_MASTER_LOCATION: ${{ github.workspace }}\CraftMaster
# # #       CRAFT_MASTER_CONFIG: ${{ github.workspace }}\craftmaster.ini
# # #       CRAFT_ROOT: ${{ github.workspace }}\windows-msvc2022_64-cl

# # #     steps:
# # #       - name: Checkout Code
# # #         uses: actions/checkout@v4
# # #         with:
# # #           fetch-depth: 0

# # #       # --- CACHE LOGIC ---
# # #       - name: Cache Craft Dependencies
# # #         id: cache-craft
# # #         uses: actions/cache@v4
# # #         with:
# # #           path: ${{ env.CRAFT_ROOT }}
# # #           key: ${{ runner.os }}-craft-v1-${{ hashFiles('**/craftmaster.ini') }}
# # #           restore-keys: |
# # #             ${{ runner.os }}-craft-v1-

# # #       - name: Setup Python
# # #         uses: actions/setup-python@v5
# # #         with:
# # #           python-version: '3.12'

# # #       - name: Install Inkscape (Required for Icons)
# # #         shell: pwsh
# # #         run: |
# # #           choco install inkscape --no-progress -y
# # #           echo "C:\Program Files\Inkscape\bin" >> $env:GITHUB_PATH

# # #       - name: Install Build Tools (Craft)
# # #         shell: pwsh
# # #         run: |
# # #           if (!(Test-Path "${{ env.CRAFT_MASTER_LOCATION }}")) {
# # #             git clone -q --depth=1 https://invent.kde.org/packaging/craftmaster.git ${{ env.CRAFT_MASTER_LOCATION }}
# # #           }
          
# # #           function craft() {
# # #               python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" --config "${{ env.CRAFT_MASTER_CONFIG }}" --target ${{ env.CRAFT_TARGET }} -c $args
# # #               if($LASTEXITCODE -ne 0) {exit $LASTEXITCODE}
# # #           }
          
# # #           craft --add-blueprint-repository "https://github.com/nextcloud/craft-blueprints-kde.git|stable-4.0|"
# # #           craft --add-blueprint-repository "https://github.com/nextcloud/desktop-client-blueprints.git|stable-4.0|"
# # #           craft craft
# # #           craft --install-deps nextcloud-client

# # #       # --- CRITICAL FIX FOR NameError: name 'os' is not defined ---
# # #       - name: Patch Blueprint Bug
# # #         shell: pwsh
# # #         run: |
# # #           $blueprintPath = "${{ env.CRAFT_ROOT }}\etc\blueprints\locations\desktop-client-blueprints\nextcloud-client\nextcloud-client.py"
# # #           if (Test-Path $blueprintPath) {
# # #             $content = Get-Content $blueprintPath
# # #             if ($content -notmatch "import os") {
# # #                 Write-Host "Patching $blueprintPath with 'import os'..."
# # #                 "import os`n" + (Get-Content $blueprintPath -Raw) | Set-Content $blueprintPath
# # #             } else {
# # #                 Write-Host "Blueprint already contains 'import os'."
# # #             }
# # #           } else {
# # #             Write-Error "Blueprint file not found at $blueprintPath"
# # #           }

# # #       - name: Compile and Package
# # #         shell: pwsh
# # #         run: |
# # #           function craft() {
# # #               python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" --config "${{ env.CRAFT_MASTER_CONFIG }}" --target ${{ env.CRAFT_TARGET }} -c $args
# # #               if($LASTEXITCODE -ne 0) {exit $LASTEXITCODE}
# # #           }
          
# # #           # Compile branded source
# # #           craft --src-dir ${{ github.workspace }} nextcloud-client
          
# # #           # Create the .exe installer
# # #           craft --package nextcloud-client

# # #       - name: Upload Branded Installer
# # #         uses: actions/upload-artifact@v4
# # #         with:
# # #           name: Branded-Nextcloud-Installer
# # #           path: |
# # #             ${{ env.CRAFT_ROOT }}\tmp\artifacts\*.exe
# # #             ${{ env.CRAFT_ROOT }}\tmp\artifacts\*.msi


# # name: Build Branded Windows Client

# # on:
# #   push:
# #     branches: [ master, main ]
# #   workflow_dispatch:

# # jobs:
# #   build:
# #     # IMPORTANT: Ensure your repo is PUBLIC to bypass the $0 budget limit
# #     runs-on: windows-2022
# #     env:
# #       CRAFT_TARGET: windows-msvc2022_64-cl
# #       CRAFT_MASTER_LOCATION: ${{ github.workspace }}\CraftMaster
# #       CRAFT_MASTER_CONFIG: ${{ github.workspace }}\craftmaster.ini
# #       CRAFT_ROOT: ${{ github.workspace }}\windows-msvc2022_64-cl

# #     steps:
# #       - name: Checkout Code
# #         uses: actions/checkout@v4
# #         with:
# #           fetch-depth: 0

# #       # --- 1. CACHE LOGIC (Idempotency) ---
# #       - name: Cache Craft Dependencies
# #         id: cache-craft
# #         uses: actions/cache@v4
# #         with:
# #           path: ${{ env.CRAFT_ROOT }}
# #           key: ${{ runner.os }}-craft-v2  # Increment version to reset cache if needed
# #           restore-keys: |
# #             ${{ runner.os }}-craft-

# #       - name: Setup Python
# #         uses: actions/setup-python@v5
# #         with:
# #           python-version: '3.12'

# #       # --- 2. TOOLS SETUP ---
# #       - name: Install Inkscape & NSIS
# #         shell: pwsh
# #         run: |
# #           choco install inkscape nsis --no-progress -y
# #           echo "C:\Program Files\Inkscape\bin" >> $env:GITHUB_PATH

# #       - name: Install Build Tools (Craft)
# #         shell: pwsh
# #         run: |
# #           if (!(Test-Path "${{ env.CRAFT_MASTER_LOCATION }}")) {
# #             git clone -q --depth=1 https://invent.kde.org/packaging/craftmaster.git ${{ env.CRAFT_MASTER_LOCATION }}
# #           }
          
# #           function craft() {
# #               python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" --config "${{ env.CRAFT_MASTER_CONFIG }}" --target ${{ env.CRAFT_TARGET }} -c $args
# #               if($LASTEXITCODE -ne 0) {exit $LASTEXITCODE}
# #           }
          
# #           craft --add-blueprint-repository "https://github.com/nextcloud/craft-blueprints-kde.git|stable-4.0|"
# #           craft --add-blueprint-repository "https://github.com/nextcloud/desktop-client-blueprints.git|stable-4.0|"
# #           craft craft
# #           craft --install-deps nextcloud-client

# #       # --- 3. PRE-BUILD BUG FIXES ---
# #       - name: Patch Blueprint and Manifest
# #         shell: pwsh
# #         run: |
# #           # Fix 1: Add missing 'import os' to the blueprint
# #           $blueprintPath = "${{ env.CRAFT_ROOT }}\etc\blueprints\locations\desktop-client-blueprints\nextcloud-client\nextcloud-client.py"
# #           if (Test-Path $blueprintPath) {
# #             $content = Get-Content $blueprintPath -Raw
# #             if ($content -notmatch "import os") {
# #                 Write-Host "Patching $blueprintPath with 'import os'..."
# #                 "import os`r`n" + $content | Set-Content $blueprintPath
# #             }
# #           }

# #           # Fix 2: Ensure the VisualElementsManifest exists to prevent 30-min crash
# #           if (!(Test-Path "theme")) { mkdir theme }
# #           $manifest = '<Application xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><VisualElements ShowNameOnSquare150x150Logo="on" Square150x150Logo="visualelements\150-Droptocloud-icon.png" Square70x70Logo="visualelements\70-Droptocloud-icon.png" ForegroundText="light" BackgroundColor="#0082c9"/></Application>'
# #           $manifest | Out-File -FilePath "theme/Droptocloud.VisualElementsManifest.xml" -Encoding utf8

# #       # --- 4. COMPILE & PACKAGE ---
# #       - name: Compile and Package
# #         shell: pwsh
# #         run: |
# #           function craft() {
# #               python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" --config "${{ env.CRAFT_MASTER_CONFIG }}" --target ${{ env.CRAFT_TARGET }} -c $args
# #               if($LASTEXITCODE -ne 0) {exit $LASTEXITCODE}
# #           }
          
# #           # Compile using your source code (Branding)
# #           craft --src-dir ${{ github.workspace }} nextcloud-client
          
# #           # Generate the final .exe
# #           craft --package nextcloud-client

# #       # --- 5. EXPORT THE INSTALLER ---
# #       - name: Upload Branded Installer
# #         uses: actions/upload-artifact@v4
# #         with:
# #           name: Droptocloud-Windows-Installer
# #           path: |
# #             ${{ env.CRAFT_ROOT }}\tmp\artifacts\*.exe
# #             ${{ env.CRAFT_ROOT }}\tmp\artifacts\*.msi


# name: Build Branded Windows Client

# on:
#   push:
#     branches: [ master, main ]
#   workflow_dispatch:

# jobs:
#   build:
#     # IMPORTANT: Ensure your repo is PUBLIC to bypass the $0 budget limit
#     runs-on: windows-2022
#     env:
#       CRAFT_TARGET: windows-msvc2022_64-cl
#       CRAFT_MASTER_LOCATION: ${{ github.workspace }}\CraftMaster
#       CRAFT_MASTER_CONFIG: ${{ github.workspace }}\craftmaster.ini
#       CRAFT_ROOT: ${{ github.workspace }}\windows-msvc2022_64-cl

#     steps:
#       - name: Checkout Code
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0

#       # --- 1. CACHE LOGIC (Idempotency) ---
#       - name: Cache Craft Dependencies
#         id: cache-craft
#         uses: actions/cache@v4
#         with:
#           path: ${{ env.CRAFT_ROOT }}
#           key: ${{ runner.os }}-craft-v2
#           restore-keys: |
#             ${{ runner.os }}-craft-

#       - name: Setup Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: '3.12'

#       # --- 2. TOOLS SETUP ---
#       - name: Install Inkscape & NSIS
#         shell: pwsh
#         run: |
#           choco install inkscape nsis --no-progress -y
#           echo "C:\Program Files\Inkscape\bin" >> $env:GITHUB_PATH

#       - name: Install Build Tools (Craft)
#         shell: pwsh
#         run: |
#           if (!(Test-Path "${{ env.CRAFT_MASTER_LOCATION }}")) {
#             git clone -q --depth=1 https://invent.kde.org/packaging/craftmaster.git ${{ env.CRAFT_MASTER_LOCATION }}
#           }

#           function craft() {
#               python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" --config "${{ env.CRAFT_MASTER_CONFIG }}" --target ${{ env.CRAFT_TARGET }} -c $args
#               if($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
#           }

#           craft --add-blueprint-repository "https://github.com/nextcloud/craft-blueprints-kde.git|stable-4.0|"
#           craft --add-blueprint-repository "https://github.com/nextcloud/desktop-client-blueprints.git|stable-4.0|"
#           craft craft
#           craft --install-deps nextcloud-client

#       # --- 3. PRE-BUILD BUG FIXES ---
#       - name: Patch Blueprint and Manifest
#         shell: pwsh
#         run: |
#           $blueprintPath = "${{ env.CRAFT_ROOT }}\etc\blueprints\locations\desktop-client-blueprints\nextcloud-client\nextcloud-client.py"
#           if (Test-Path $blueprintPath) {
#             $content = Get-Content $blueprintPath -Raw
#             if ($content -notmatch "import os") {
#               "import os`r`n$content" | Set-Content $blueprintPath
#             }
#           }

#           if (!(Test-Path "theme")) { mkdir theme }
#           $manifest = '<Application xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><VisualElements ShowNameOnSquare150x150Logo="on" Square150x150Logo="visualelements\150-nextcloud-icon.png" Square70x70Logo="visualelements\70-nextcloud-icon.png" ForegroundText="light" BackgroundColor="#0082c9"/></Application>'
#           $manifest | Out-File -FilePath "theme/Droptocloud.VisualElementsManifest.xml" -Encoding utf8

#       # --- 4. COMPILE & PACKAGE ---
#       - name: Compile and Package
#         shell: pwsh
#         run: |
#           function craft() {
#               python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" --config "${{ env.CRAFT_MASTER_CONFIG }}" --target ${{ env.CRAFT_TARGET }} -c $args
#               if($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
#           }

#           craft --src-dir ${{ github.workspace }} nextcloud-client
#           craft --package nextcloud-client

#       # --- 5. EXPORT THE INSTALLER (FIXED PATH ONLY) ---
#       - name: Upload Branded Installer
#         uses: actions/upload-artifact@v4
#         with:
#           name: Droptocloud-Windows-Installer
#           path: |
#             ${{ env.CRAFT_ROOT }}\tmp\*.exe
#             ${{ env.CRAFT_ROOT }}\tmp\*.msi


name: Build Branded Windows MSI Client

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    env:
      CRAFT_TARGET: windows-msvc2022_64-cl
      CRAFT_MASTER_LOCATION: ${{ github.workspace }}\CraftMaster
      CRAFT_MASTER_CONFIG: ${{ github.workspace }}\craftmaster.ini
      CRAFT_ROOT: ${{ github.workspace }}\windows-msvc2022_64-cl

    steps:
      # -------------------------------------------------
      # 1. CHECKOUT
      # -------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------------------------------
      # 2. CACHE CRAFT
      # -------------------------------------------------
      - name: Cache Craft
        uses: actions/cache@v4
        with:
          path: ${{ env.CRAFT_ROOT }}
          key: windows-craft-v3
          restore-keys: |
            windows-craft-

      # -------------------------------------------------
      # 3. PYTHON
      # -------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # -------------------------------------------------
      # 4. TOOLS (INKSCAPE + WIX)
      # -------------------------------------------------
      - name: Install Inkscape and WiX
        shell: pwsh
        run: |
          choco install inkscape wixtoolset --no-progress -y
          echo "C:\Program Files\Inkscape\bin" >> $env:GITHUB_PATH

      # -------------------------------------------------
      # 5. INSTALL CRAFT
      # -------------------------------------------------
      - name: Install Craft
        shell: pwsh
        run: |
          if (!(Test-Path "${{ env.CRAFT_MASTER_LOCATION }}")) {
            git clone --depth=1 https://invent.kde.org/packaging/craftmaster.git `
              "${{ env.CRAFT_MASTER_LOCATION }}"
          }

          function craft {
            param([Parameter(ValueFromRemainingArguments=$true)]$Args)
            python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" `
              --config "${{ env.CRAFT_MASTER_CONFIG }}" `
              --target ${{ env.CRAFT_TARGET }} -c @Args
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          }

          craft --add-blueprint-repository "https://github.com/nextcloud/craft-blueprints-kde.git|stable-4.0|"
          craft --add-blueprint-repository "https://github.com/nextcloud/desktop-client-blueprints.git|stable-4.0|"
          craft craft
          craft --install-deps nextcloud-client

      # -------------------------------------------------
      # 6. PATCH + BRANDING (100% SAFE)
      # -------------------------------------------------
      - name: Patch Blueprint and Branding
        shell: pwsh
        run: |
          $bp = "${{ env.CRAFT_ROOT }}\etc\blueprints\locations\desktop-client-blueprints\nextcloud-client\nextcloud-client.py"
          if (Test-Path $bp) {
            $content = Get-Content $bp -Raw
            if ($content -notmatch "import os") {
              "import os`r`n$content" | Set-Content $bp
            }
          }

          if (!(Test-Path "theme")) {
            New-Item -ItemType Directory -Path theme | Out-Null
          }

          $file = "theme\Droptocloud.VisualElementsManifest.xml"
          if (Test-Path $file) { Remove-Item $file }

          Add-Content $file '<Application xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">'
          Add-Content $file '  <VisualElements'
          Add-Content $file '    ShowNameOnSquare150x150Logo="on"'
          Add-Content $file '    Square150x150Logo="visualelements\150-nextcloud-icon.png"'
          Add-Content $file '    Square70x70Logo="visualelements\70-nextcloud-icon.png"'
          Add-Content $file '    ForegroundText="light"'
          Add-Content $file '    BackgroundColor="#0082c9"/>'
          Add-Content $file '</Application>'

      # -------------------------------------------------
      # 7. BUILD + PACKAGE (MSI ONLY)
      # -------------------------------------------------
      - name: Build MSI
        shell: pwsh
        run: |
          function craft {
            param([Parameter(ValueFromRemainingArguments=$true)]$Args)
            python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" `
              --config "${{ env.CRAFT_MASTER_CONFIG }}" `
              --target ${{ env.CRAFT_TARGET }} -c @Args
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          }

          craft --src-dir ${{ github.workspace }} nextcloud-client
          craft --package nextcloud-client --package-type msi

      # -------------------------------------------------
      # 8. UPLOAD MSI ONLY
      # -------------------------------------------------
      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: Droptocloud-Windows-MSI
          path: |
            ${{ env.CRAFT_ROOT }}\tmp\*.msi

