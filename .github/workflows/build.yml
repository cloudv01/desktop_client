name: Build Branded Windows Client

on:
  push:
    branches: [ master, main ]
  workflow_dispatch: # Allows you to run it manually

jobs:
  build:
    runs-on: windows-2022
    env:
      CRAFT_TARGET: windows-msvc2022_64-cl
      CRAFT_MASTER_LOCATION: ${{ github.workspace }}\CraftMaster
      CRAFT_MASTER_CONFIG: ${{ github.workspace }}\craftmaster.ini

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Build Tools (Craft)
        shell: pwsh
        run: |
          git clone -q --depth=1 https://invent.kde.org/packaging/craftmaster.git ${{ env.CRAFT_MASTER_LOCATION }}
          
          function craft() {
              python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" --config "${{ env.CRAFT_MASTER_CONFIG }}" --target ${{ env.CRAFT_TARGET }} -c $args
              if($LASTEXITCODE -ne 0) {exit $LASTEXITCODE}
          }
          
          # Initialize environment
          craft --add-blueprint-repository "https://github.com/nextcloud/craft-blueprints-kde.git|stable-4.0|"
          craft --add-blueprint-repository "https://github.com/nextcloud/desktop-client-blueprints.git|stable-4.0|"
          craft craft
          craft --install-deps nextcloud-client

      - name: Compile and Package
        shell: pwsh
        run: |
          function craft() {
              python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" --config "${{ env.CRAFT_MASTER_CONFIG }}" --target ${{ env.CRAFT_TARGET }} -c $args
              if($LASTEXITCODE -ne 0) {exit $LASTEXITCODE}
          }
          
          # Build using your source code
          craft --src-dir ${{ github.workspace }} nextcloud-client
          # Create the .exe installer
          craft --package nextcloud-client

      - name: Upload Branded Installer
        uses: actions/upload-artifact@v4
        with:
          name: Branded-Nextcloud-Installer
          path: |
            ${{ github.workspace }}\${{ env.CRAFT_TARGET }}\tmp\artifacts\*.exe
            ${{ github.workspace }}\${{ env.CRAFT_TARGET }}\tmp\artifacts\*.msi
